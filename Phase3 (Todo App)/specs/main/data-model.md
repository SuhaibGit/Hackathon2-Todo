# Data Model: Todo AI Chatbot

## Overview
This document defines the new data models required for implementing the AI Chatbot feature, focusing on conversation persistence and message history management.

## New Entity: Conversation

### Attributes
- **id**: UUID (Primary Key) - Unique identifier for the conversation
- **user_id**: String (Foreign Key) - Links to the authenticated user (from Better Auth)
- **title**: String (Optional) - Auto-generated title based on first message or topic
- **created_at**: DateTime - Timestamp when conversation was created
- **updated_at**: DateTime - Timestamp when conversation was last updated

### Relationships
- One User → Many Conversations (one-to-many)
- One Conversation → Many Messages (one-to-many)

### Validation Rules
- user_id must correspond to a valid user in the system
- created_at and updated_at automatically managed by system
- Each conversation belongs exclusively to one user (enforced by user_id)

## New Entity: Message

### Attributes
- **id**: UUID (Primary Key) - Unique identifier for the message
- **conversation_id**: UUID (Foreign Key) - Links to parent conversation
- **role**: String - Enum of ('user', 'assistant', 'tool') indicating message source
- **content**: Text - The actual message content
- **tool_calls**: JSON (Optional) - Details of tools called by assistant (if role='assistant')
- **tool_call_id**: String (Optional) - Reference to specific tool call (if role='tool')
- **created_at**: DateTime - Timestamp when message was created

### Relationships
- Many Messages → One Conversation (many-to-one)
- Message content may reference Task entities through tool calls

### Validation Rules
- conversation_id must correspond to a valid conversation
- role must be one of 'user', 'assistant', or 'tool'
- created_at automatically managed by system
- content length should be reasonable (not empty)
- When role='tool', content should be structured response from custom tool

## Updated Task Entity Usage

### Additional Constraints for Chat Context
- All task operations through custom tools must validate user_id matches conversation owner
- Task visibility is restricted to user who owns the task
- Task operations (create/read/update/delete/complete) must preserve audit trail in messages

## Database Schema

### Conversation Table
```sql
CREATE TABLE conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id VARCHAR(255) NOT NULL REFERENCES users(id),
    title VARCHAR(255),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

CREATE INDEX idx_conversations_user_id ON conversations(user_id);
CREATE INDEX idx_conversations_updated_at ON conversations(updated_at);
```

### Message Table
```sql
CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID NOT NULL REFERENCES conversations(id),
    role VARCHAR(20) NOT NULL CHECK (role IN ('user', 'assistant', 'tool')),
    content TEXT NOT NULL,
    tool_calls JSONB,
    tool_call_id VARCHAR(255),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

CREATE INDEX idx_messages_conversation_id ON messages(conversation_id);
CREATE INDEX idx_messages_role ON messages(role);
CREATE INDEX idx_messages_created_at ON messages(created_at);
```

## State Transitions

### Conversation Lifecycle
1. **Created**: When first chat message is initiated by user
2. **Active**: During ongoing conversation
3. **Inactive**: When conversation hasn't been updated for extended period (archival consideration)

### Message Lifecycle
1. **Created**: When new message is received from user or generated by assistant
2. **Stored**: Persisted in database with timestamp
3. **Retrieved**: Loaded as part of conversation history

## Security Considerations

### Data Access Control
- Every database query must filter by user_id to prevent unauthorized access
- Conversation ownership must be validated before any read/write operations
- Message access is inherited from parent conversation ownership

### Privacy Protection
- Only messages from user's own conversations should be accessible
- No cross-user data access allowed through any query
- Audit trail preserved for compliance purposes

## Performance Considerations

### Query Optimization
- Indexes on user_id, conversation_id, and timestamps for efficient querying
- Pagination support for conversations with many messages
- Limit on message history returned (max 25 messages per spec requirement)

### Data Retention
- Automatic cleanup policies for old conversations (future enhancement)
- Soft deletion pattern to maintain data integrity
- Backup and recovery procedures following existing patterns